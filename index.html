<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDPA - Base de Datos de Progreso Automatizado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS Principal -->
    <?!= HtmlService.createHtmlOutputFromFile('css/main').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('css/modal').getContent() ?>
</head>
<body>
    <!-- Contenedor de Login -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <img src="https://i.imgur.com/Uw8kbQO.png" alt="Logo Larnet" class="login-logo">
                <h1>BDPA</h1>
                <p>Base de Datos de Progreso Automatizado</p>
            </div>
            
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </form>
            
            <div id="login-loader" class="loader hidden">
                <i class="fas fa-spinner fa-spin"></i> Iniciando sesión...
            </div>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div id="main-menu-container" class="main-container hidden">
        <!-- Header -->
        <?!= HtmlService.createHtmlOutputFromFile('partials/header').getContent() ?>
        
        <!-- Navegación -->
        <nav class="main-nav">
            <div class="nav-container">
                <a href="#" class="nav-link" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="nav-link" data-section="obras">
                    <i class="fas fa-building"></i> Obras
                </a>
                <a href="#" class="nav-link" data-section="avances">
                    <i class="fas fa-tasks"></i> Avances
                </a>
                <a href="#" class="nav-link" data-section="inventario">
                    <i class="fas fa-boxes"></i> Inventario
                </a>
                <a href="#" class="nav-link" data-section="transferencias">
                    <i class="fas fa-exchange-alt"></i> Transferencias
                </a>
                <a href="#" class="nav-link" data-section="planificacion-metas">
                    <i class="fas fa-bullseye"></i> Planificación
                </a>
                <a href="#" class="nav-link" data-section="mediciones">
                    <i class="fas fa-ruler"></i> Mediciones
                </a>
                <a href="#" class="nav-link" data-section="documentacion">
                    <i class="fas fa-file-alt"></i> Documentación
                </a>
                <a href="#" class="nav-link" data-section="cobranzas">
                    <i class="fas fa-chart-line"></i> Progreso
                </a>
                <a href="#" class="nav-link" data-section="reportes">
                    <i class="fas fa-chart-bar"></i> Reportes
                </a>
                <a href="#" class="nav-link admin-only" data-section="gestion-usuarios">
                    <i class="fas fa-users"></i> Usuarios
                </a>
                <a href="#" class="nav-link admin-only" data-section="configuracion">
                    <i class="fas fa-cog"></i> Configuración
                </a>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="container hidden">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Obras Activas</h3>
                        <div class="dashboard-number" id="total-obras-activas">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Avances Hoy</h3>
                        <div class="dashboard-number" id="avances-hoy">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Transferencias Pendientes</h3>
                        <div class="dashboard-number" id="transferencias-pendientes">0</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Documentos</h3>
                        <div class="dashboard-number" id="total-documentos">0</div>
                    </div>
                </div>
            </div>

            <!-- Obras -->
            <div id="obras" class="container hidden">
                <h2><i class="fas fa-building"></i> Gestión de Obras</h2>
                <!-- Contenido de obras se carga dinámicamente -->
            </div>

            <!-- Avances -->
            <div id="avances" class="container hidden">
                <h2><i class="fas fa-tasks"></i> Registro de Avances</h2>
                <!-- Contenido de avances se carga dinámicamente -->
            </div>

            <!-- Inventario -->
            <div id="inventario" class="container hidden">
                <h2><i class="fas fa-boxes"></i> Gestión de Inventario</h2>
                <!-- Contenido de inventario se carga dinámicamente -->
            </div>

            <!-- Transferencias -->
            <div id="transferencias" class="container hidden">
                <h2><i class="fas fa-exchange-alt"></i> Transferencias de Material</h2>
                <!-- Contenido de transferencias se carga dinámicamente -->
            </div>

            <!-- Planificación y Metas -->
            <div id="planificacion-metas" class="container hidden">
                <h2><i class="fas fa-bullseye"></i> Planificación y Metas</h2>
                <!-- Contenido de planificación se carga dinámicamente -->
            </div>

            <!-- Mediciones -->
            <div id="mediciones" class="container hidden">
                <h2><i class="fas fa-ruler"></i> Sistema de Mediciones</h2>
                <!-- Contenido de mediciones se carga dinámicamente -->
            </div>

            <!-- Documentación -->
            <div id="documentacion" class="container hidden">
                <h2><i class="fas fa-file-alt"></i> Gestión Documental</h2>
                <!-- Contenido de documentación se carga dinámicamente -->
            </div>

            <!-- Cobranzas/Progreso -->
            <div id="cobranzas" class="container hidden">
                <h2><i class="fas fa-chart-line"></i> Registro de Progreso</h2>
                <!-- Contenido de cobranzas se carga dinámicamente -->
            </div>

            <!-- Reportes -->
            <div id="reportes" class="container hidden">
                <h2><i class="fas fa-chart-bar"></i> Sistema de Reportes</h2>
                <!-- Contenido de reportes se carga dinámicamente -->
            </div>

            <!-- Gestión de Usuarios -->
            <div id="gestion-usuarios" class="container hidden">
                <h2><i class="fas fa-users"></i> Gestión de Usuarios</h2>
                <!-- Contenido de usuarios se carga dinámicamente -->
            </div>

            <!-- Configuración -->
            <div id="configuracion" class="container hidden">
                <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                <!-- Contenido de configuración se carga dinámicamente -->
            </div>
        </main>

        <!-- Footer -->
        <?!= HtmlService.createHtmlOutputFromFile('partials/footer').getContent() ?>
    </div>

    <!-- Modal de Maquetación -->
    <?!= HtmlService.createHtmlOutputFromFile('partials/modal-maquetacion').getContent() ?>

    <!-- Scripts - ORDEN CRÍTICO CORREGIDO -->
    <script>
        // ============================================================================
        // VARIABLES GLOBALES ÚNICAS - DECLARADAS UNA SOLA VEZ
        // ============================================================================
        
        // Variables de sesión - DECLARACIÓN ÚNICA
        let usuarioActual = null;
        let tokenSesion = null;
        
        // Variables de estado - DECLARACIÓN ÚNICA
        let sistemaInicializado = false;
        
        console.log('[BDPA] Variables globales inicializadas');
    </script>

    <!-- 1. MÓDULOS CORE - CARGAR PRIMERO -->
    <?!= HtmlService.createHtmlOutputFromFile('js/core-utils').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/core-notifications').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/core-navigation').getContent() ?>

    <!-- 2. MÓDULO API - SEGUNDO -->
    <?!= HtmlService.createHtmlOutputFromFile('js/api').getContent() ?>

    <!-- 3. MÓDULOS ESPECÍFICOS - TERCERO -->
    <?!= HtmlService.createHtmlOutputFromFile('js/obras').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/avances').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/inventario').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/transferencias').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/mediciones').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/documentacion').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/cobranzas').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/planificacion').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/reportes').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/configuracion').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/usuarios').getContent() ?>
    <?!= HtmlService.createHtmlOutputFromFile('js/maquetacion').getContent() ?>

    <!-- 4. MÓDULO PRINCIPAL - ÚLTIMO -->
    <?!= HtmlService.createHtmlOutputFromFile('js/main').getContent() ?>

    <!-- 5. INICIALIZACIÓN FINAL -->
    <script>
        // ============================================================================
        // INICIALIZACIÓN FINAL DEL SISTEMA
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[BDPA] Inicializando sistema...');
            
            // Verificar que las funciones críticas estén disponibles
            if (typeof mostrarNotificacion !== 'function') {
                console.error('[BDPA] ERROR CRÍTICO: mostrarNotificacion no está disponible');
                alert('Error crítico: Sistema de notificaciones no disponible');
                return;
            }
            
            if (typeof mostrarSeccion !== 'function') {
                console.error('[BDPA] ERROR CRÍTICO: mostrarSeccion no está disponible');
                alert('Error crítico: Sistema de navegación no disponible');
                return;
            }
            
            // Verificar integridad del sistema
            setTimeout(() => {
                validarIntegridadSistema();
            }, 1000);
            
            // Inicializar con pantalla de login
            mostrarSeccion('login');
            
            // Marcar como inicializado
            sistemaInicializado = true;
            
            console.log('[BDPA] Sistema inicializado correctamente');
            mostrarInfo('Sistema BDPA cargado correctamente', 3000);
        });
        
        /**
         * Validar integridad del sistema
         */
        function validarIntegridadSistema() {
            const elementosRequeridos = [
                'login-container',
                'main-menu-container',
                'dashboard',
                'obras',
                'avances',
                'inventario',
                'transferencias',
                'planificacion-metas',
                'mediciones',
                'documentacion',
                'cobranzas',
                'reportes',
                'gestion-usuarios',
                'configuracion'
            ];
            
            const errores = [];
            
            elementosRequeridos.forEach(id => {
                if (!document.getElementById(id)) {
                    errores.push(`Elemento requerido no encontrado: ${id}`);
                }
            });
            
            if (errores.length > 0) {
                console.error('[BDPA] Errores de integridad del sistema:', errores.join(','));
            } else {
                console.log('[BDPA] ✅ Integridad del sistema verificada');
            }
        }
        
        console.log('[BDPA] index.html cargado completamente');
    </script>
</body>
</html>